<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="dakdak-file-uploader" attributes="">
  <template>
    <dakdak-globals id="globals"></dakdak-globals>
    <link rel="stylesheet" href="dakdak-file-uploader.css">

    <core-ajax
      auto
      id="ajax-s3link-get"
      url="{{$.globals.config.apiUrl}}s3link"
      method="GET"
      handleAs="json"
      on-core-response="{{handleS3linkResponse}}"></core-ajax>

    <core-ajax
      id="ajax-img-create"
      url="{{$.globals.config.apiUrl}}image"
      method="POST"
      params="{{imageModel}}"
      handleAs="json"
      on-core-response="{{handleImgCreateResponse}}"></core-ajax>

    <core-ajax
      url="{{s3link.signed_request}}"
      id="ajax-s3-upload"
      headers='{"x-amz-acl": "public-read"}'
      method="PUT"
      handleAs="xml"
      on-core-response="{{handleS3UploadResponse}}"></core-ajax>

    <h3>Kuvaupload</h3>

    <input type="file" name="kekefile" id="vanillafile" on-change="{{setFiles}}">
    <paper-button raised on-click="{{doFileUpload}}">Upload</paper-button>

  </template>

  <script>
    (function () {
      Polymer({
        created: function() {
          this.s3link = {};
          this.imageModel = {};
        },

        setFiles: function(e, detail, sender) {
          this.$['ajax-s3-upload'].body = sender.files[0];
          this.$['ajax-s3-upload'].contentType = sender.files[0].type;
        },

        handleS3linkResponse: function(event, result) {
          this.s3link = result.response;

          this.imageModel.s3id = this.s3link.s3id;
        },

        doFileUpload: function() {
          this.$['ajax-s3-upload'].go();
        },

        handleS3UploadResponse: function() {
          this.$['ajax-img-create'].go();
        },

        handleImgCreateResponse: function(event, result, sender) {
          _.extend(this.imageModel, result.response);
        }
      });
    })();
  </script>
</polymer-element>
